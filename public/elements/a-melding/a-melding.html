<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-item/paper-item.html">

<link rel="import" href="../../components/firebase-element/firebase.html">
<link rel="import" href="../../components/firebase-element/firebase-collection.html">


<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/iron-selector/iron-selector.html">

<link rel="import" href="../../components/iron-localstorage/iron-localstorage.html">


<link rel="import" href="../../components/iron-ajax/iron-ajax.html">
<script src="../../components/lodash/lodash.js"></script>
<script src="../../components/momentjs/moment.js"></script>
<script src="../../components/momentjs/locale/nl.js"></script>
<script src="http://rsvpjs-builds.s3.amazonaws.com/rsvp-latest.min.js"></script>  

<script src="https://cdn.firebase.com/libs/geofire/3.2.2/geofire.min.js"></script>  

<script src="../../components/node-uuid/uuid.js"></script>  

<link rel="import" href="../file-upload/file-upload.html">
<link rel="import" href="../a-meldingitem/a-meldingitem.html">


<dom-module id="a-melding">
  <style>
    :host {
      display: block;
/*      width: 100%;
*/
      font-family: 'Open Sans', sans-serif;
      @apply(--layout-vertical);
      @apply(--layout-start);

    }

    h3 {
      margin: 0px;
      padding: 0px;
      font-weight: 300;
      font-size: 20px;
    }


    h4 {
      margin: 0px 0px 0px 0px;
      padding: 0px;
      font-weight: 300;
      font-size: 14px;
      color: #cccccc;

    }


    h1 {
      margin: 0px;
      padding: 0px;
      font-weight: 300;
      font-size: 26px;
    }



    paper-button {
      border-radius: 0px;
      outline: 0;
      border-style:solid;
      -webkit-appearance: none;
    }


    paper-input-container{
      --paper-input-container-color: #A1B56E;
      --paper-input-container-focus-color:black;

    }




    #regloc {
      margin-top: 10px;
      width: 80%;
      max-width: 600px;
    }

    #geoloc {
      margin-top: 20px;
      width: 100%;
    }


    .btnz {
      margin: 0px;
      padding: 0px;
      border: none;
    }

    .streetz {
      border-bottom: 1px solid #A1B56E;
      margin: 0px;
      padding: 10px 0px 10px 0px; 
      width: 60%;
      background-color: white;
    }

    .greenbg {
      background-color: #D9F299;
      width: 100%;
      margin: 0px;
      box-sizing: border-box;
      padding: 50px 0px 50px 50px;
    }

    .whitebg {
      background-color: white;
      width: 100%;
      margin: 0px;
      box-sizing: border-box;
      padding: 30px 50px 50px 50px;
    }

    .intro {
      @apply(--layout-horizontal);
      @apply(--layout-center);
      margin: 0px 0px 40px 0px;

    }

    .intro img {
      width: 80px;
      margin: 0px 15px 0px 0px;
    }

    .intro small {
      font-weight: 800;
      font-size: 11px;
      margin-top: 2px;
    }


    .vertical {
      @apply(--layout-vertical);
    }

    .horizontal {
      @apply(--layout-horizontal);
    }

    .wrap {
      @apply(--layout-wrap);
    }

    a-calitem {
      width: auto;
    }

    a-fractie {
      margin-right: 10px;
    }

  </style>
  <template>

    <iron-ajax
    handle-as="json"
    on-response="handleResponse"
    debounce-duration="300"
    id="ophaalkal"></iron-ajax>


<!-- 
  <div id="geoloc">
    <button>Gebruik mijn huidige locatie!</button>
  </div> -->
  <div class="greenbg">

    <div class="intro">

       <img src="../../images/a_zwart-rgb.svg">

      <div class="vertical">
      <small>AstadLabs Prototype</small>
      <h1>OPHAALKALENDER</h1>
      <small>{{userid}}</small>
    </div>
    </div>

  <div id="regloc">
  <template is="dom-if" if="{{!locationpos}}">
  <p>Dus hier moet een button komen met een beetje uitleg; als u hier klikt gaat uw telefoon vragen of hij uw locatie mag doorgeven, geef toestemming om verder te gaan. </p>
  <paper-button on-tap="getLocation">Geef mijn locatie door</paper-button>
  </template>

  <template is="dom-if" if="{{locationpos}}">
    <file-upload id="imageupload" imgval="{{imageval}}"></file-upload>
    <paper-input-container>
  <label>Opmerkingen?</label>
  <input is="iron-input" maxlength="144" prevent-invalid-input bind-value="{{comment}}">
  <paper-input-char-counter></paper-input-char-counter>
</paper-input-container>
    <paper-button on-tap="saveIt">Versturen</paper-button>
  </template>

  </div>

  </div>

  <div class="partII">


  <firebase-collection id="fbgetmeld" location="{{fblocation}}"
          data="{{usermeldingen}}"></firebase-collection>

  <template is="dom-repeat" items={{usermeldingen}} index-as="key">
    <a-meldingitem key="{{item.key}}"></a-meldingitem>
  </template>

  </div>

  <iron-localstorage name="ophaal-bendillen2" value="{{userid}}"></iron-localstorage>




</template>
</dom-module>
<script>
(function() {

  function showPosition(position) {
    //    var that = this;
    latitude = position.coords.latitude;
    longitude = position.coords.longitude;
    //window.dispatchEvent(build);
  };

  Polymer({
    is: 'a-melding',

    properties: {
      imageval: {
        type: String
      },
      ophaal: {
        type: Object
      }
    },

    ready: function(){
      this.locationpos = false;
      //this.$.fbgetmeld.location='https://ophaal.firebaseio.com/user/'+this.userid+'/';
    },

    // hier als er nog niets in localstorage zit

    initializeDefault: function(){

    },


    getLocation: function() {

      this.fblocation = 'https://ophaal.firebaseio.com/user/'+this.userid+'/';

      if (navigator.geolocation) {
        this.locpos = navigator.geolocation.getCurrentPosition(showPosition);
        //console.log(this.locpos);
        this.locationpos = true;
      } else {
        console.log("Geolocation is not supported by this browser.");
      }
    },

    saveIt: function(){

      if(this.userid==null){
        this.userid = uuid.v1();
      };

      console.log('ik ga saven: ', longitude, latitude, this.imageval, this.comment);

      var today = Date.now();

      testFB = new Firebase('https://ophaal.firebaseio.com/meldingen');

      var userid = this.userid;

      var testID = testFB.push({'lon':longitude, 'lat':latitude, 'image':this.imageval, 'comment':this.comment, 'tijd': today, 'user': userid });

      var newKey = testID.key();

      console.log(newKey);

      this.doGeofire(newKey, longitude, latitude);

      var userMelding = new Firebase('https://ophaal.firebaseio.com/user/'+userid);

      var usermeldingID = userMelding.push({'key': newKey });

    },

    doGeofire: function(key, long, lat){
      var firebaseRef = new Firebase('https://ophaal.firebaseio.com/geopoints/');
      var geoFire = new GeoFire(firebaseRef);
      geoFire.set(key, [lat, long]).then(function() {
        console.log("Provided key has been added to GeoFire");
      }, function(Error) {
        console.log("Error: " + error);
      });
    }

 

  });
})();
</script>
